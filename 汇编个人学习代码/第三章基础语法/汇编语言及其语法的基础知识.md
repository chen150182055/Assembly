# 汇编语言及其语法的基础知识



- #### 3.1简介

  1. 了解x86和x86_64汇编语言

  2. 了解三种较为流行的汇编器GAS、NASM、MASM

     | 汇编器 | 语法  | 开发环境                |
     | ------ | ----- | ----------------------- |
     | GAS    | AT&T  | Apple Xcode             |
     | MASM   | Intel | Microsoft Visual Studio |
     | NASM   | Intel | Linux系统命令行界面     |
     |        |       |                         |

- #### 3.2基本元素

  ​	这里要注意，我们的汇编语言是一种底层语言，每一行代码只执行一项操作。

  ​	所以，我们需要了解计算机体系结构的一些细节，例如CPU寄存器、标志位、浮点运算功能等。

  ###### 	3.2.1 汇编代码五大支柱

  1. 保留字(reserved word)：一种具备特定用途的字词，代表一种特定的指令，指令(如MOV)、命令(例如PROC)、寄存器(例如eax)、属性(例如可以当做.MODEL命令参数值的FLAT等)
  2. 标识符(identifier)：由程序员所定义的名称，用来表示变量、常量及过程的事物，它最多可以包含247个字符
     - 第一个字符不能是数字，并且必须是英文字母、下划线、问号、at符号、美元符号的一种
  3. 命令(directive)：与指令集无关的一些操作，可以指挥汇编器去做某件事情，例如定义变量、指明内存段等
  4. 区段(section)：用相关命令所标出的特殊段落
  5. 指令(instruction)：程序的可执行语句
     - 语法：mnemonic [operands]   (mnemonic是助记符，是指令的名称)（operands是操作数）

  ###### 3.2.2 字面量

  1. 字面量(Iliteral value,字面值)也叫做立即值(immediate,立即数)，用来表示由开发者明确指明的值，例如整数、字符串、实数、字符等。

     - 整数字面量(integer literal)一般写为十进制的整数，在有些情况下也可以采用其他进制来写。NASM和MASM允许开发者在字面量之后写上一个表示基数的字符，以指出这个字面量所采用的进制。

     - 实数(real number)：要比整数复杂的多

     - 字符字面量（character literal）：是由单个字符所构成的值，与整数字面量一样，也用来表示那种开发者在编写代码的时候就已经很清楚的值    
     
     - 字符串字面量（string literal）：是由多个字符字面量所组成的，通常用来表示单词或者短语。 
     
        
     
       | 基数 | 进制               |
       | :--: | ------------------ |
       |  b   | 二进制（以2为底）  |
       |  d   | 十进制（以10为底） |
       |  h   | 十六进制(以16为底) |
       | q,o  | 八进制（以8为底）  |
       |      |                    |

#### 例子

```assembly
00011111b   ;	
31			;
31d			;
1Fh			;
37o			; 
```

  

###### 		3.2.3 标签与注释

1. 标签（label）：可以用来划分代码，以表达某种与编程或设计有关的想法。它不仅·可以·让代码读起来更加清晰，而且有时候还能够帮助开发者实现跳转或者循环等功能，使得程序可以跳到标签所标识的这个地方。标签的写法是在标识符后跟一个冒号

   ```assembly
   idenftifier;
   ```

2. 注释:多行注释和单行注释

   ```assembly
   ;单行注释
   ```

     

#### 3.3 定义数据  

​	1.变量的定义	

	GAS/NASM

```assembly
[标识符:] 命令 初始化器 [,初始化器]...
```

注意：无论那种汇编器.data段里定义的变量都必须予以初始化，也就是必须具有初始值

	NASM创建变量的一个例子：

```assembly
counter:	DB 0
wageArray:	DD 75,100,125
```

注意：这种一个标识符后带有多个初始化器的写法可以用来创建数组

2. 如何定义未初始化变量

   - 这种变量不具备初始值，它主要是为了在内存中预留一定的空间供开发者使用。

   - 不同汇编器对这种变量的定义有较大的区别

     - 例如NASM和GAS都要求.data段里的变量必须用明确的值来初始化,而MASM则允许开发者在改段中采用问号（？）充当变量的初始化器来定义未初始化变量  

       MASM

       ```assembly
       .data
       num DWORD	6
       sum SDWORD	?
       myArray	BYTE 10 UDP (1)
       myUArray BYTE 10 UDP (?)	
       ```

       ​	

     - MASM的初始化器可以用DUP括起来，以便反复创建大小和内容均相同的多个值

   - GAS和NASM则要求未初始化的变量必须创建在.bss段中(block Started by Symbol)

     - NASM

       ```assembly
       SECTION .bss
       memAddr: RESD 1
       buffer: RESB 64
       ```

3. 字符串

   - 字符串是以BYTE（字节）数组的方式存储的。字符串必须以null结尾，也就是说，其最后一个字节必须是0的ASCCII码。

     - NASM：直接用字面量0来设置最后一个字节

       ```assembly
       motd: DB "How about a nice",0Ah,"game of chess",0
       ```

     - MASM:和NASM一样
     - GAS：在字符串末尾写上\0,表示该字符串以null结尾

   - 字符串换行的问题：

     - NASM:只用一个十六进制码（也就是LF）表示换行

       ```assembly
       motd: DB "How about a nice",0Ah,"game of chess",0
       ```

     - GAS:使用转义符号\n来插入换行符号

     - MASM:用十六进制码0Dh与0Ah来表示CR/LF这两个符号并以实现换行

4. 符号常量

   - 可以在MASM版本的汇编代码里面取代某些变量，用以表示程序执行期间绝对不会变化的值。

   - x86的符号常量能够表示32位整数，x86_64的符号常量能够表示64位整数，常量表示的都是基于整数的数据。

     - MASM

       ```
       标识符 = 值
       ```

   - 符号常量的优点：

     1. 如果程序需要多次用到某个值，那么专门用一个标识符来表示这个值比每次用到的时候都写一遍更加合理。
     2. MASM里的符号常量不占内存，因为MASM在对代码做汇编时会将出现的符号常量改成常量所对应的实际值

   - 所有汇编器都可以把表达式的值表示成符号常量。符号必须用EQU命令来定义。

     - 用EQU所创建的符号既可以出现在数据段也可以出现在代码段(即对于GAS汇编器，它可以出现在.data与.text段，对于MASM汇编器，它可以出现在.data与.code段，对于NASM汇编器,它可以出现在SECTION .data 与SECTION .text段)。

       NASM

       ```assembly
       identifier: EQU expression
       identifier: EQU value
       identifier: EQU "text"
       ```

     - EQU的另外一个用途

       - 通过创建符号常量来表示某个标识符所指代的数据占用了多大的内存空间。

       - 当前位置计数器：用来指代位置计数器的当前内存地址（GAS用句点.表示NASM和MASM用美元符号表示$），将该地址与前一个字符串的起始地址相减即可算出字符串所占据的字节数

         NASM

         ```assembly
         motd: DB "I'm in the matrix?",0
         len: EQU ($ - motd)
         ```

         
